1. ZK注册中心ZkRegistryCenter的的启动与销毁

重构前，初始化和销毁方法依赖于bean的生命周期。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2I5N2MwNmZlOGJkYjhhM2YyMzY2M2Q1YmJmNTM2MTRfcmVTMUc4ZEs5SFNTUFVzM3h4eFJNQUxLYnpBYVZRR0hfVG9rZW46SHJUY2JYSFYzbzYzTHN4aGFVZGM4djlYblNjXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

这样带来的问题是当整个服务停止时，销毁方法先执行，客户端和zk服务端已经断开连接，而服务取消注册的逻辑再执行时，就不会成功。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=OGI0MWQ5MTUwMjYxMWE4ZjAzMzM3YTU1MjdmYWQ3MGZfYmpicktlTG5OZFkxa1NYemlvNDJpYWFBclhEQVNEUEVfVG9rZW46UHpKUWJlYUF5bzkxOXd4d01PUGMyN2I5bnNkXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

由于取消注册使用的是quietly()方式，出错了也不会报错，最终就是服务没有取消成功，消费者还可能调用到。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=ODM2MGZlNzVhY2YxYTFiMzc5MzYzMjljMWRhYjQ3NzNfMEdBSHU3aVVXY0YxNHVkYkdCSkJmUUJHYlVZeURVRzdfVG9rZW46RXJOWmJuY1Mzb1gzb1d4SjdidmNacGlublFnXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

重构后，注册中心先启动成功，在进行服务注册。服务销毁时，先取消注册，在关闭连接。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=MTZjZjFjNzk2NDYyNjljMGYzN2I0YjlkNWJiNTk4MTdfaTR5Z2F6RlJXQnh6NElGME16UmJyblBiUTA4VzdoSnRfVG9rZW46SFVXQmIxZEp2b3NsSGp4am9Gb2NSMWVUbnFkXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

2. 抽取类型转换逻辑到工具类TypeUtils中。

这样带来的好处是业务功能和非业务功能逻辑分离，提高代码可读性和可复用性。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=NTE5NDVjMjE1ODM2NDEzZTc4NWVkYWI3NjAwNmYwOTdfTEtKWGZaZjhnWGo4cXBXZ3ZSbTMyTWxSZU90YlBybk9fVG9rZW46QzhPUmJWNkZSb3BLcEl4R1l3RGNVdmNQbkVPXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

3. 网络客户端封装为接口

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=NTBjYWFkYThjZDI4NTYzNjc5NTQwMzM0ZTkwMjcyMWRfalAxTlV2ZkRHY3JsNUdDRjFpSGp5cDdJd3BQMGZRaURfVG9rZW46SG9wd2JkUDA1b0FmdUR4NU9RaGNTT2lLbkdiXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

定义HttpInvoker接口，添加当前使用的方式OkHttp作为客户端。这样基于接口设计带来的好处时想使用其他客户端时就很方便替换，不需要改变上层逻辑，添加新的实现类即可。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=NGJjNzZlODQ1ZmRkMDhkYmU5Mzg5MzFlYTQ3MGExNTdfOXZuU3JxZU9SMjY0cWxxOW85RzZZelNPOEs0QUtDQ0tfVG9rZW46VmFYSmJCVFBHb1Q2Z2x4eGJ1emNneFBQbm5kXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

4. 封装ServiceMeta和InstanceMeta

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=YzgzOWIwYjljOWI3M2Q3Zjc4NmRkMDRlNTFkYzIwYzhfNUYyckI5djBWdFhLY21SVExMdUxyRjA3YWxDMXZBU1VfVG9rZW46Q3o1dGIzVDBDb1BLbUV4c213ZGNENXg2bmJkXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

使用ServiceMeta代替String类型，来表示一个服务的元数据，表达含义更加丰富，支持更多非功能性场景。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=MjI2NDhhMTgwOTZhYTIyZDBlNmQxZDA3OTdhNjRkZTJfVFRWOTc5WmZEanNkMHdoek1TOEs4U25kN0lhM1N1TmxfVG9rZW46TVN1YWIyNDkybzVla3F4bElwOWNYNWE5bktmXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

同理，使用InstanceMeta代替String类型，来表示一个实例的元数据，表达含义更加丰富，支持更多非功能性场景。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=MDZiNTAzNGY0MjczMWNlMmU2MzUwOTI3ZmIxYTFmOTdfemQ5eVJjZHJHbVYzMEV3dEMwYkE1aXdrM1hDWkpFVmxfVG9rZW46TXRVc2J2OUdnb04zbnJ4QjRjdGN3ZGRDbmdiXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

5. 封装ProviderInvoker

将服务提供者的调用逻辑抽出独立的类，职责更单一。

![img](https://qxjtjpi1tsf.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2QwY2EwOGY2MzVkM2Q1NDg4Y2RhMDYyNDYyY2Q3MDlfZ3FSZk5QQzAzSEkyT0duQzVHcmxoVE1PSmV3SzNCTG9fVG9rZW46S3h4TWJtRkxJbzVWTFd4eFhaSGM4ZGtabnpiXzE3MTExMDg2MzQ6MTcxMTExMjIzNF9WNA)

此次，重构的要点

1. 业务功能和非功能性逻辑分开，提高可读性和可扩展性。
2. 使用保证类型替换String类型，丰富表达含义。
3. 工具类抽取，提高复用性。
4. 基于接口做设计，提高扩展性。
5. 类职责保持单一，解耦，类聚。